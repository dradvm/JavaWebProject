</html>
<!DOCTYPE html>
<!--
Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
Click nbfs://nbhost/SystemFileSystem/Templates/Other/html.html to edit this template
-->
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{Layout/layout}">

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/b42e1089e2.js" crossorigin="anonymous"></script>
    <script src="../../static/js/jquery.min.js"></script>
    <script src="../../static/js/angular.min.js"></script>
    <link rel="stylesheet" href="../../static/css/mycss.css">
</head>

<body>
    <div layout:fragment="contentMainPage">
        <div ng-app="detailsCaterer">
            <div class="container mt-5" ng-controller="detailsCaterer">
                <div class="row h-25">
                    <div class="col-4 h-100 ">
                        <div class="position-relative overflow-hidden rounded border h-100">
                            <img th:src="${caterer.profileImage}" class="w-100" alt="" style="filter: blur(4px);">
                            <div class="overflow-hidden position-absolute top-0 left-0 w-100 bg-black opacity-25"
                                style="height: 100%;">

                            </div>
                            <div class="position-absolute mx-3 my-4 top-0 left-0 w-100">
                                <div class="v-stack">
                                    <div class="d-flex align-items-center">
                                        <div class=" rounded-circle overflow-hidden"
                                            style="width: 60px; height: 60px; border: 3px solid #ccc;">
                                            <img th:src="${caterer.profileImage}" class="w-100 h-100" alt="">
                                        </div>
                                        <div class="v-stack ms-3 gap">
                                            <div class="fs-5 text-white" style="text-shadow: 1px 1px black;"
                                                th:text="${caterer.fullName}">
                                            </div>
                                            <div class="fs-7 text-white" style="text-shadow: 1px 1px black;">
                                                <i style="width: 26px;" class="fa-solid fa-phone"></i>
                                                <span class="fs-7" th:text="${caterer.phone}"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="v-stack mt-3">
                                        <div class="fs-7 text-white" style="text-shadow: 1px 1px black;">
                                            <i style="width: 26px;" class="fa-solid fa-city"></i>
                                            <span class="fs-7" th:text="${caterer.districtID.cityID.cityName}"></span>
                                        </div>
                                        <div class="fs-7 text-white" style="text-shadow: 1px 1px black;">
                                            <i style="width: 26px;" class="fa-solid fa-building-circle-arrow-right"></i>
                                            <span class="fs-7" th:text="${caterer.districtID.districtName}"></span>
                                        </div>
                                        <div class="fs-7 text-white" style="text-shadow: 1px 1px black;">
                                            <i style="width: 26px;" class="fa-solid fa-location-dot"></i>
                                            <span class="fs-7" th:text="${caterer.address}"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button class="position-absolute " style="top: 3%; right: 3%;">
                                <div class="favorite-floating-btn favorite-floating-btn-mark">
                                    <i class="fa-solid fa-heart heart"></i>
                                </div>
                            </button>
                        </div>
                    </div>
                    <div class="col-4 h-100">
                        <div class="d-flex flex-column h-100 ms-3 mt-4">
                            <div class="my-2 d-flex align-items-center">
                                <i class=" fa-regular fa-id-card" style="width: 26px;"></i>
                                <span>Rank: </span>
                                <span class="text-danger ms-2 fw-medium" th:text="${caterer.rankID.rankID}"></span>
                            </div>
                            <div class="my-2 d-flex align-items-center">
                                <i class=" fa-regular fa-star" style="width: 26px;"></i>
                                <span>Rate: </span>
                                <span class="text-danger ms-2 fw-medium" th:text="${caterer.catererRating}"></span>
                            </div>
                            <div class="my-2 d-flex align-items-center">
                                <i class=" fa-regular fa-heart" style="width: 26px;"></i>
                                <span>Favorite: </span>
                                <span class="text-danger ms-2 fw-medium"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-4 h-100">
                        <div class="d-flex flex-column h-100 ms-3 mt-4">
                            <div class="my-2 d-flex align-items-center">
                                <i class=" fa-solid fa-plate-wheat" style="width: 26px;"></i>
                                <span>Product: </span>
                                <span class="text-danger ms-2 fw-medium">240</span>
                            </div>
                            <div class="my-2 d-flex align-items-center">
                                <i class=" fa-solid fa-user-check" style="width: 26px;"></i>
                                <span>Join Time: </span>
                                <span class="text-danger ms-2 fw-medium" th:text="${caterer.createDate}">240</span>
                            </div>
                            <div class="my-2 d-flex align-items-center">
                                <i class=" fa-solid fa-basket-shopping" style="width: 26px;"></i>
                                <span>Order: </span>
                                <span class="text-danger ms-2 fw-medium"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row my-row mt-5  gy-2">
                    <div class="col-3" ng-virtual-scroll ng-repeat="(index, item) in listDish">
                        <div id="dish-{{$index}}" class="overflow-hidden v-stack bg-white border"
                            style="border-radius: 12px;">
                            <div>
                                <img ng:src="{{item.image}}" alt="" class="w-100" style="height: 150px;">
                            </div>
                            <div class="px-3 py-3"
                                th:unless="${session.get('scopedTarget.authController') != null && session.get('scopedTarget.authController').role == 'Caterer}">
                                <div class="fs-6 fw-medium d-flex align-items-center" style="min-height: 50px;">
                                    {{item.name}}</div>
                                <div class="fs-6 fw-medium mt-2">${{item.price}}</div>
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <div class="border rounded overflow-hidden">
                                        <button class="my-btn bg-main text-white fw-bold px-3 py-1" data-action="minus"
                                            type="button" onclick="updateValue(this, 'minus')">-</button>
                                        <input class="border-0 text-center" style="outline: 0; width: 30px;"
                                            type="number" name="product-qty" min="0" max="999" value="1" oninput="this.value = 
                                            this.value >= 0 && this.value <= 999 ? Math.abs(this.value) : null">
                                        <button class="my-btn bg-main text-white fw-bold px-3 py-1" data-action="add"
                                            type="button" onclick="updateValue(this, 'add')">+</button>
                                    </div>
                                    <button
                                        th:if="${session.get('scopedTarget.authController') != null && session.get('scopedTarget.authController').role == 'Customer'}"
                                        class="fw-medium my-btn p-2 rounded-circle text-white rounded-pill bg-main"
                                        ng-click="addDish(item, index)">
                                        <i class="fa-solid fa-bag-shopping"></i>
                                    </button>
                                    <a th:unless="${session.get('scopedTarget.authController') != null && session.get('scopedTarget.authController').role == 'Customer'}"
                                        href="/auth/toLogin">
                                        <button
                                            class="fw-medium my-btn p-2 rounded-circle text-white rounded-pill bg-main">
                                            <i class="fa-solid fa-bag-shopping"></i>
                                        </button>
                                    </a>
                                </div>

                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <div class="position-fixed bottom-0 end-0 mb-4 me-4 z-2">

                <button class="my-btn rounded-circle p-3 bg-main" onclick="toggleModalOrder()">
                    <i class="fa-solid fa-list text-white"></i>
                </button>
            </div>

            <div ng-controller="order" class="position-fixed bottom-0 end-0 me-4 z-3 d-none" id="modalOrder"
                style="margin-bottom: 5rem;">
                <div class="border bg-white rounded overflow-hidden" style="width: 400px; height: 85vh">
                    <div class="v-stack">
                        <div class="w-100 bg-main d-flex align-items-center justify-content-around" style="height: 8%;">
                            <div class="fs-5 fw-medium py-2 text-white">Your Order</div>
                        </div>
                        <div class="px-3 py-2 overflow-auto" style="height: 57%;">
                            <div class="mb-2 border rounded px-3 py-2" ng-repeat="(index, item) in order"
                                id="order-{{$index}}">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div style="width: 85%;">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div class="fw-medium">{{item.name}}</div>
                                            <div class="fw-medium">${{item.price}}</div>
                                        </div>
                                        <div class="mt-2 d-flex align-items-center justify-content-between">
                                            <div class="border rounded overflow-hidden">
                                                <button class="my-btn bg-main text-white fw-bold px-3 py-1"
                                                    data-action="minus" type="button"
                                                    ng-click="updateValueDishOrder(item, index, $event, 'minus')">-</button>
                                                <input class="border-0 text-center" style="outline: 0; width: 30px;"
                                                    type="number" name="product-qty" min="0" max="999" readonly
                                                    value="{{item.quantity}}">
                                                <button class="my-btn bg-main text-white fw-bold px-3 py-1"
                                                    data-action="add" type="button"
                                                    ng-click="updateValueDishOrder(item, index, $event, 'add')">+</button>
                                            </div>
                                            <div class="fw-medium fs-5">
                                                ${{calcTotal(item.price, item.quantity)}}
                                            </div>
                                        </div>
                                    </div>
                                    <div style="width: 10%; cursor: pointer;"
                                        class="bg-danger d-flex align-items-center justify-content-around p-2 rounded"
                                        ng-click="deleteDish(item)">
                                        <i class="fa-solid fa-trash text-white"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-main w-100 px-3 py-2 d-flex flex-column justify-content-between"
                            style="height: 35%;">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center justify-content-between">
                                    <select id="voucher" class="form-select fs-7" ng-model="selectedVoucher">
                                        <option class="fs-7" ng-value="null">Select voucher</option>
                                        <option class="fs-7" ng-value="item" ng-repeat="item in listVoucher">
                                            {{item.voucherValue + item.typeID == 1 ? "%" : ""}}</option>
                                    </select>
                                </div>

                                <div class="d-flex align-items-center justify-content-between">
                                    <input type="text" class="form-control" placeholder="Enter point" id="point">
                                </div>
                            </div>
                            <div class=" d-flex align-items-center justify-content-between">
                                <div class="fw-medium">Total</div>
                                <div class="fw-bold">{{totalValue}}</div>
                            </div>
                            <div class="">
                                <div class="input-group my-input-form">
                                    <textarea type="text" class="form-control" placeholder="Note"
                                        id="caterer-description" maxlength="200"></textarea>
                                </div>
                            </div>
                            <button class="my-btn bg-white rounded-pill w-100 py-2 fw-medium">
                                Make order
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            const myApp = angular.module("detailsCaterer", [])
                .factory("CatererService", function ($http, $location) {
                    var x = $location.absUrl().split("/")
                    var n = x.length
                    return {
                        getCatererDish: function () {
                            return $http.get("/getCatererDish/" + x[n - 1])
                        },
                        getCatererVoucher: function () {
                            return $http.get("/getCatererVoucher/" + x[n - 1])
                        },

                    }

                })
                .controller("detailsCaterer", function ($scope, $http, $location, CatererService) {
                    var x = $location.absUrl().split("/")
                    var n = x.length
                    $scope.addDish = function (dish, index) {
                        var orderCaterer = JSON.parse(sessionStorage.getItem(x[n - 1]))
                        var data = []
                        quantity = parseInt(document.querySelector(`#dish-${index}`).querySelector("input[name='product-qty']").value)
                        console.log(dish, index)
                        dish.id = index
                        if (orderCaterer) {
                            currentDish = orderCaterer.find((item) => item.id == index)
                            if (currentDish && parseInt(currentDish.quantity) + quantity <= 999) {
                                currentDish.quantity = parseInt(currentDish.quantity) + quantity
                                sessionStorage.setItem(x[n - 1], JSON.stringify(orderCaterer))
                            }
                            else {
                                dish.quantity = quantity
                                orderCaterer.push(dish)
                                sessionStorage.setItem(x[n - 1], JSON.stringify(orderCaterer))

                            }
                        }
                        else {
                            dish.quantity = quantity
                            sessionStorage.setItem(x[n - 1], JSON.stringify([dish]))
                        }
                    }
                    CatererService.getCatererDish()
                        .then(function (res) {
                            console.log(res)
                            $scope.listDish = res.data

                        })
                })
                .controller("order", function ($scope, $location, $window, CatererService) {
                    var x = $location.absUrl().split("/")
                    var n = x.length
                    CatererService.getCatererVoucher()
                        .then(function (res) {
                            console.log(res)
                            $scope.listVoucher = res.data

                        })
                    $scope.updateValueDishOrder = function (dish, index, button, operation) {

                        updateValue(button.currentTarget, operation)
                        quantity = parseInt(document.querySelector(`#order-${index}`).querySelector("input[name='product-qty']").value)

                        data = JSON.parse(sessionStorage.getItem(x[n - 1]))
                        data.find((item) => item.id == dish.id).quantity = quantity
                        sessionStorage.setItem(x[n - 1], JSON.stringify(data))

                    }
                    $scope.deleteDish = function (dish) {
                        data = JSON.parse(sessionStorage.getItem(x[n - 1]))
                        data = data.filter((item) => item.id != dish.id)
                        sessionStorage.setItem(x[n - 1], JSON.stringify(data))
                    }
                    $scope.render = function () {
                        $scope.order = JSON.parse(sessionStorage.getItem(x[n - 1]))
                        $scope.totalValue = $scope.order !== null ? $scope.order.reduce((sum, item) => sum += item.quantity * item.price, 0) : 0
                    };

                    // Khởi tạo controller
                    $scope.render();

                    $scope.$watch(
                        function () {
                            return $window.sessionStorage.getItem(x[n - 1]);
                        },
                        function (newVal, oldVal) {
                            if (newVal !== oldVal) {
                                $scope.render();
                            }
                        }
                    );

                    $scope.calcTotal = function (price, quantity) {
                        return price * quantity
                    }
                })
            function toggleModalOrder() {
                if (document.querySelector("#modalOrder").classList.contains("d-none")) {
                    document.querySelector("#modalOrder").classList.remove("d-none")
                }
                else {
                    document.querySelector("#modalOrder").classList.add("d-none")
                }
            }
            function updateValue(button, operation) {
                // Get the input element
                const input = button.parentElement.querySelector('input[name="product-qty"]');
                // Parse the current value of the input
                let value = parseInt(input.value);
                // Update the value based on the operation
                if (operation === 'minus' && value > parseInt(input.min)) {
                    value -= 1;
                } else if (operation === 'add' && value < parseInt(input.max)) {
                    value += 1;
                }
                // Set the new value back to the input
                input.value = value;
            }
        </script>
    </div>

</body>

</html>