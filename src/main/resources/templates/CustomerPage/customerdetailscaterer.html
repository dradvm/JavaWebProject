</html>
<!DOCTYPE html>
<!--
Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
Click nbfs://nbhost/SystemFileSystem/Templates/Other/html.html to edit this template
-->
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{Layout/layout}">

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/b42e1089e2.js" crossorigin="anonymous"></script>
    <script src="../../static/js/jquery.min.js"></script>
    <script src="../../static/js/angular.min.js"></script>
    <link rel="stylesheet" href="../../static/css/mycss.css">
</head>

<body>
    <div layout:fragment="contentMainPage">
        <div>
            <div class="container mt-5">
                <div class="row h-25">
                    <div class="col-4 h-100 ">
                        <div class="position-relative overflow-hidden rounded border h-100">
                            <img th:src="${profileImg}" class="w-100" alt="" style="filter: blur(4px);">
                            <div class="overflow-hidden position-absolute top-0 left-0 w-100 bg-black opacity-25"
                                style="height: 100%;">

                            </div>
                            <div class="position-absolute mx-3 my-4 top-0 left-0 w-100">
                                <div class="v-stack">
                                    <div class="d-flex align-items-center">
                                        <div class=" rounded-circle overflow-hidden"
                                            style="width: 60px; height: 60px; border: 3px solid #ccc;">
                                            <img th:src="${profileImg}" class="w-100 h-100" alt="">
                                        </div>
                                        <div class="v-stack ms-3 gap">
                                            <div class="fs-5 text-white" style="text-shadow: 1px 1px black;"
                                                th:text="${caterer.fullName}">
                                            </div>
                                            <div class="fs-7 text-white" style="text-shadow: 1px 1px black;">
                                                <i style="width: 26px;" class="fa-solid fa-phone"></i>
                                                <span class="fs-7" th:text="${caterer.phone}"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="v-stack mt-3">
                                        <div class="fs-7 text-white" style="text-shadow: 1px 1px black;">
                                            <i style="width: 26px;" class="fa-solid fa-city"></i>
                                            <span class="fs-7" th:text="${caterer.districtID.cityID.cityName}"></span>
                                        </div>
                                        <div class="fs-7 text-white" style="text-shadow: 1px 1px black;">
                                            <i style="width: 26px;" class="fa-solid fa-building-circle-arrow-right"></i>
                                            <span class="fs-7" th:text="${caterer.districtID.districtName}"></span>
                                        </div>
                                        <div class="fs-7 text-white" style="text-shadow: 1px 1px black;">
                                            <i style="width: 26px;" class="fa-solid fa-location-dot"></i>
                                            <span class="fs-7" th:text="${caterer.address}"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button class="position-absolute " style="top: 3%; right: 3%;">
                                <div class="favorite-floating-btn favorite-floating-btn-mark">
                                    <i class="fa-solid fa-heart heart"></i>
                                </div>
                            </button>
                        </div>
                    </div>
                    <div class="col-4 h-100">
                        <div class="d-flex flex-column h-100 ms-3 mt-4">
                            <div class="my-2 d-flex align-items-center">
                                <i class=" fa-regular fa-id-card" style="width: 26px;"></i>
                                <span>Rank: </span>
                                <span class="text-danger ms-2 fw-medium" th:text="${caterer.rankID.rankID}"></span>
                            </div>
                            <div class="my-2 d-flex align-items-center">
                                <i class=" fa-regular fa-star" style="width: 26px;"></i>
                                <span>Rate: </span>
                                <span class="text-danger ms-2 fw-medium" th:text="${caterer.catererRating}"></span>
                            </div>
                            <div class="my-2 d-flex align-items-center">
                                <i class=" fa-regular fa-heart" style="width: 26px;"></i>
                                <span>Favorite: </span>
                                <span class="text-danger ms-2 fw-medium"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-4 h-100">
                        <div class="d-flex flex-column h-100 ms-3 mt-4">
                            <div class="my-2 d-flex align-items-center">
                                <i class=" fa-solid fa-plate-wheat" style="width: 26px;"></i>
                                <span>Product: </span>
                                <span class="text-danger ms-2 fw-medium">240</span>
                            </div>
                            <div class="my-2 d-flex align-items-center">
                                <i class=" fa-solid fa-user-check" style="width: 26px;"></i>
                                <span>Join Time: </span>
                                <span class="text-danger ms-2 fw-medium" th:text="${caterer.createDate}">240</span>
                            </div>
                            <div class="my-2 d-flex align-items-center">
                                <i class=" fa-solid fa-basket-shopping" style="width: 26px;"></i>
                                <span>Order: </span>
                                <span class="text-danger ms-2 fw-medium"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row my-row mt-5  gy-2">
                    <div class="col-3" th:each="dish : ${dishList}">
                        <div class="overflow-hidden v-stack bg-white border" style="border-radius: 12px;">
                            <div>
                                <img th:src="${dish.dishImage}" alt="" class="w-100" style="height: 150px;">
                            </div>
                            <div class="px-3 py-3">
                                <div class="fs-6 fw-medium d-flex align-items-center" style="min-height: 50px;"
                                    th:text="${dish.dishName}">
                                </div>
                                <div class="fs-6 fw-medium mt-2" th:text="${'$' + dish.dishPrice}"></div>
                                <form onsubmit="addDish(event, this)"
                                    th:unless="${session.get('scopedTarget.authController') != null && session.get('scopedTarget.authController').role == 'Caterer'}"
                                    class="d-flex justify-content-between align-items-center mt-3">

                                    <input type="hidden" name="id" th:value="${dish.dishID}">
                                    <div class="border rounded overflow-hidden">
                                        <button class="my-btn bg-main text-white fw-bold px-3 py-1" data-action="minus"
                                            type="button" onclick="updateValue(this, 'minus')">-</button>
                                        <input class="border-0 text-center" style="outline: 0; width: 30px;"
                                            type="number" name="quantity" min="0" max="999" value="1" oninput="this.value = 
                                                   this.value >= 0 && this.value <= 999 ? Math.abs(this.value) : null">
                                        <button class="my-btn bg-main text-white fw-bold px-3 py-1" data-action="add"
                                            type="button" onclick="updateValue(this, 'add')">+</button>
                                    </div>
                                    <button type="submit"
                                        th:if="${session.get('scopedTarget.authController') != null && session.get('scopedTarget.authController').role == 'Customer'}"
                                        class="fw-medium my-btn p-2 rounded-circle text-white rounded-pill bg-main"
                                        ng-click="addDish(item, index, $event)">
                                        <i class="fa-solid fa-bag-shopping"></i>
                                    </button>
                                    <a th:unless="${session.get('scopedTarget.authController') != null && session.get('scopedTarget.authController').role == 'Customer'}"
                                        href="/auth/toLogin">
                                        <button type="button"
                                            class="fw-medium my-btn p-2 rounded-circle text-white rounded-pill bg-main">
                                            <i class="fa-solid fa-bag-shopping"></i>
                                        </button>
                                    </a>
                                </form>

                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <div th:if="${session.get('scopedTarget.authController') != null && session.get('scopedTarget.authController').role == 'Customer'}"
                class="position-fixed bottom-0 end-0 mb-4 me-4 z-2">

                <button class="my-btn rounded-circle p-3 bg-main" onclick="toggleModalOrder()">
                    <i class="fa-solid fa-list text-white"></i>
                </button>
            </div>

            <div th:if="${session.get('scopedTarget.authController') != null && session.get('scopedTarget.authController').role == 'Customer'}"
                class="position-fixed bottom-0 end-0 me-4 z-3 d-none" id="modalOrder" style="margin-bottom: 5rem;">
                <div class="border bg-white rounded overflow-hidden" style="width: 700px; height: 70vh">
                    <div class="v-stack">
                        <div class="w-100 bg-main d-flex align-items-center justify-content-around" style="height: 8%;">
                            <div class="fs-5 fw-medium py-2 text-white">Your Order</div>
                        </div>
                        <div id="orderHasList" class="d-flex" style="height: 92%;">
                            <div class="w-50 bg-white">
                                <div class="px-3 py-2 overflow-auto h-100">
                                    <div id="orderDishes">

                                    </div>
                                </div>
                            </div>
                            <div class="w-50 bg-main">

                                <div class=" w-100 h-100 px-3 py-2 d-flex flex-column justify-content-between">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="fw-medium">Voucher:</div>
                                        <select class="form-select ms-3" id="selectedVoucher" onchange="calcTotal()">
                                            <option value="0" selected>No voucher</option>
                                            <option th:each="voucher : ${voucherList}" th:value="${voucher.voucherID}"
                                                th:text="${voucher.voucherID + ' ' + voucher.typeID.typeID + ' ' + voucher.voucherValue}">
                                            </option>
                                        </select>
                                    </div>

                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="fw-medium" style="width: 70%;">Use Point?:</div>
                                        <select class="form-select" id="usePoint" onchange="calcTotal()">
                                            <option value="0" selected>No</option>
                                            <option value="1">Yes</option>
                                        </select>
                                    </div>
                                    <div class="v-stack">

                                        <label class="fw-medium" for="orderTime">
                                            Order time (yyyy-MM-dd HH:mm)<span style="color:red;">*</span>:
                                        </label>
                                        <input class="form-control mt-1" id="orderTime" type="datetime">
                                        <div id="orderTime-error"></div>
                                    </div>

                                    <div>
                                        <select class="form-select mb-2" id="address-type" onchange="changeAddress()">
                                            <option value="0" selected>Use new address</option>
                                            <option value="1" th:if="${addressList != null}">Use your available delivery
                                                address</option>
                                        </select>
                                        <div id="address-type-0">
                                            <label for="address" class="mb-1 fw-medium">
                                                Delivery address<span style="color:red;">*</span>:
                                            </label>
                                            <input class="form-control" id="address-0">
                                            <div id="address-0-error"></div>
                                            <select class="form-control" id="districtID">
                                                <option th:each="district : ${districtList}"
                                                    th:value="${district.districtID}"
                                                    th:text="${district.districtName + ', ' + district.cityID.cityName}">
                                                </option>
                                            </select>
                                        </div>
                                        <div id='address-type-1' style="display: none;">
                                            <select class="form-control" id='address-1'>
                                                <option th:each="address : ${addressList}"
                                                    th:value="${address.addressID}"
                                                    th:text="${address.address + ', ' + address.districtID.districtName + ', ' + address.districtID.cityID.cityName}">
                                                </option>
                                            </select>
                                        </div>
                                    </div>


                                    <div class=" d-flex align-items-center justify-content-between">
                                        <div class="fw-medium">Total</div>
                                        <div class="fw-bold">
                                            <total id="total"></total>
                                        </div>
                                    </div>
                                    <div class="">
                                        <div class="input-group my-input-form">
                                            <textarea type="text" class="form-control" placeholder="Note" id="note"
                                                maxlength="200"></textarea>
                                        </div>
                                    </div>

                                    <div id="error"></div>
                                    <button class="my-btn bg-white rounded-pill w-100 py-2 fw-medium"
                                        onclick="createOrder()">
                                        Make order
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="orderEmpty" style="height: 92%;">
                            <div class="w-100 h-100 d-flex flex-column align-items-center justify-content-around">
                                <img th:src="@{/images/empty-cart.png}" class="w-100" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div>
            <!-- <div th:each="dish : ${dishList}">
                <img th:src="${dish.dishImage}" />
                <div th:text="${dish.dishName}"></div>
                <div th:text="${'$' + dish.dishPrice}"></div>
                <form onsubmit="addDish(event, this)">
                    <input type="hidden" name="id" th:value="${dish.dishID}">
                    <input type="number" name="quantity" value="0">
                    <button type="submit" ons>Add</button>
                </form>
            </div> -->
            <div>
                <div></div>
                <!-- <form>
                    <label for="selectedVoucher">Voucher:</label>
                    <select id="selectedVoucher" onchange="calcTotal()">
                        <option value="0" selected>No voucher</option>
                        <option th:each="voucher : ${voucherList}" th:value="${voucher.voucherID}"
                            th:text="${voucher.voucherID + ' ' + voucher.typeID.typeID + ' ' + voucher.voucherValue}">
                        </option>
                    </select>
                    <label for="usePoint">Use point?</label>
                    <select id="usePoint" onchange="calcTotal()">
                        <option value="0" selected>No</option>
                        <option value="1">Yes</option>
                    </select>
                    <label for="orderTime">
                        Order time (yyyy-MM-dd HH:mm)<span style="color:red;">*</span>:
                    </label>
                    <input id="orderTime" type="datetime">
                    <div id="orderTime-error"></div>
                    <select id="address-type" onchange="changeAddress()">
                        <option value="0" selected>Use new address</option>
                        <option value="1" th:if="${addressList != null}">Use your available delivery address</option>
                    </select>
                    <div id="address-type-0">
                        <label for="address">
                            Delivery address<span style="color:red;">*</span>:
                        </label>
                        <input id="address-0">
                        <div id="address-0-error"></div>
                        <select id="districtID">
                            <option th:each="district : ${districtList}" th:value="${district.districtID}"
                                th:text="${district.districtName + ', ' + district.cityID.cityName}">
                            </option>
                        </select>
                    </div>
                    <div id='address-type-1' style="display: none;">
                        <select id='address-1'>
                            <option th:each="address : ${addressList}" th:value="${address.addressID}"
                                th:text="${address.address + ', ' + address.districtID.districtName + ', ' + address.districtID.cityID.cityName}">
                            </option>
                        </select>
                    </div>
                    <label for="note">Note</label>
                    <textarea id="note"></textarea>
                    <div id="error"></div>
                    <button type="button" onclick="createOrder()">Create order</button>
                </form> -->
            </div>
        </div>
        <script th:src="@{/js/jquery.min.js}"></script>
        <script>
            function toggleModalOrder() {
                if (document.querySelector("#modalOrder").classList.contains("d-none")) {
                    document.querySelector("#modalOrder").classList.remove("d-none")
                }
                else {
                    document.querySelector("#modalOrder").classList.add("d-none")
                }
            }
            function updateValue(button, operation) {
                // Get the input element
                const input = button.parentElement.querySelector('input[name="quantity"]');
                // Parse the current value of the input
                let value = parseInt(input.value);
                // Update the value based on the operation
                if (operation === 'minus' && value > parseInt(input.min)) {
                    value -= 1;
                } else if (operation === 'add' && value < parseInt(input.max)) {
                    value += 1;
                }
                // Set the new value back to the input
                input.value = value;
            }
            $(document).ready(function () {
                displayOrderedDishes();
                $('#districtID').prop('selectedIndex', 0);
            });

            function changeAddress() {
                if ($('#address-type').val() === 0) {
                    $('#address-type-0').css({
                        display: 'block'
                    });
                    $('#address-type-1').css({
                        display: 'none'
                    });
                }
                else {
                    $('#address-type-0').css({
                        display: 'none'
                    });
                    $('#address-type-1').css({
                        display: 'block'
                    });
                }
            }

            function addDish(event, form) {
                event.preventDefault();
                $(document).ready(function () {
                    data = new FormData(form);
                    id = data.get('id');
                    quantity = 0;
                    if (data.get('quantity') !== '') {
                        quantity = data.get('quantity');
                    }
                    form.reset();
                    $.ajax({
                        url: '/addDish',
                        type: 'POST',
                        data: {
                            id: id,
                            quantity: quantity
                        },
                        success: function () {
                            displayOrderedDishes();
                        }
                    });
                });
            }

            function writeOrderedDishTag(dish) {
                id = dish.id;
                name = dish.name;
                img = dish.img;
                price = dish.price;
                quantity = dish.quantity;
                result = `<div>
                                <img src="` + img + `"/>
                                <div>` + name + `</div>
                                <div>` + (price * quantity) + `</div>
                                <form onsubmit="addDish(event, this)">
                                    <input type="hidden" name="id" value="` + id + `">
                                    <input type="hidden" name="quantity" value="-1">
                                    <button type="submit">-</button>
                                </form>
                                <div>` + quantity + `</div>
                                <form onsubmit="addDish(event, this)">
                                    <input type="hidden" name="id" value="` + id + `">
                                    <input type="hidden" name="quantity" value="1">
                                    <button type="submit">+</button>
                                </form>
                            </div>`;
                result = `<div class="mb-2 border rounded px-3 py-2" ng-repeat="(index, item) in order">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div style="width: 20%;" class="rounded overflow-hidden">
                                        <img src="${img}" class="w-100"/>
                                    </div>
                                    <div style="width: 65%;">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div class="fw-medium">${name}</div>
                                            <div class="fw-medium">$${price}</div>
                                        </div>
                                        <div class="mt-2 d-flex align-items-center justify-content-between">
                                            <div class="d-flex border rounded overflow-hidden">
                                                <form onsubmit="addDish(event, this)">
                                                    <input type="hidden" name="id" value="` + id + `">
                                                    <input type="hidden" name="quantity" value="-1">
                                                    <button  class="my-btn bg-main text-white fw-bold px-3 py-1" type="submit">-</button>
                                                </form>
                                                <input class="border-0 text-center" style="outline: 0; width: 30px;"
                                                    type="number" name="product-qty" min="0" max="999" readonly
                                                    value="${quantity}">
                                                <form onsubmit="addDish(event, this)">
                                                    <input type="hidden" name="id" value="` + id + `">
                                                    <input type="hidden" name="quantity" value="1">
                                                    <button  class="my-btn bg-main text-white fw-bold px-3 py-1" type="submit">+</button>
                                                </form>
                                            </div>
                                            <div class="fw-medium fs-5">
                                                ${(price * quantity)}
                                            </div>
                                        </div>
                                    </div>
                                    <form onsubmit="addDish(event, this)" style="width: 10%; cursor: pointer;"
                                        class="bg-danger d-flex align-items-center justify-content-around p-2 rounded"
                                        >
                                        <input type="hidden" name="id" value="` + id + `">
                                        <input type="hidden" name="quantity" value="${-quantity}">
                                        <button type="submit"><i class="fa-solid fa-trash text-white"></i></button>
                                    </form>
                                </div>
                            </div>`
                return result;
            }

            function displayOrderedDishes() {
                $(document).ready(function () {
                    $.ajax({
                        url: '/getOrderListFE',
                        type: 'POST',
                        success: function (response) {
                            newHtml = '';
                            count = 0
                            for (let index = 0; index < response.length; index++) {
                                if (response[index].quantity > 0) {
                                    newHtml += writeOrderedDishTag(response[index]);
                                    count++;
                                }
                            }
                            changeStateModal(count != 0)
                            $('#orderDishes').html(newHtml);
                            calcTotal();
                        }
                    });
                });
            }

            function changeStateModal(check) {

                var list = document.querySelector("#orderHasList")
                var modal = document.querySelector("#orderEmpty")
                if (list == null || modal == null) {
                    return
                }
                if (check) {
                    if (modal.classList.contains("d-none")) {

                    }
                    else {
                        modal.classList.add("d-none")
                    }
                    if (list.classList.contains("d-none")) {
                        list.classList.remove("d-none")
                    }
                    else {

                    }
                }
                else {
                    if (modal.classList.contains("d-none")) {
                        modal.classList.remove("d-none")
                    }
                    if (list.classList.contains("d-none")) {

                    }
                    else {
                        list.classList.add("d-none")
                    }
                }
            }

            function calcTotal() {
                $(document).ready(function () {
                    $.ajax({
                        url: '/calcTotal',
                        type: 'GET',
                        data: {
                            voucherID: $('#selectedVoucher').val(),
                            usePoint: $('#usePoint').val()
                        },
                        success: function (response) {
                            $('#total').text('$' + response);
                        }
                    });
                });
            }

            function createOrder() {
                $(document).ready(function () {
                    $('#orderTime-error').text('');
                    $('#address-0-error').text('');
                    $('#error').text('');
                    voucherID = $('#selectedVoucher').val();
                    usePoint = $('#usePoint').val();
                    orderTime = $('#orderTime').val();
                    addressType = $('#address-type').val();
                    address0 = $('#address-0').val();
                    districtID = $('#districtID').val();
                    address1 = 0;
                    note = $('#note').val();
                    if (addressType == 1) {
                        address1 = $('#address-1').val();
                    }
                    valid = true;
                    regex = /^[0-9]{4}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1]) (2[0-3]|[01][0-9]):[0-5][0-9]$/;

                    const inputDate = new Date(orderTime);


                    const currentDate = new Date();
                    if (!regex.test(orderTime) || inputDate < currentDate) {
                        valid = false;
                        $('#orderTime-error').text('Please enter valid time');
                    }
                    if (addressType == 0 && address0.trim().length === 0) {
                        valid = false;
                        $('#address-0-error').text('Please enter address');
                    }
                    if (!valid) {
                        return;
                    }
                    $.ajax({
                        url: '/createOrder',
                        type: 'POST',
                        data: {
                            voucherID: voucherID,
                            usePoint: usePoint,
                            orderTime: orderTime,
                            addressType: addressType,
                            address0: address0,
                            districtID: districtID,
                            address1: address1,
                            note: note
                        },
                        success: function (response) {
                            if (response.status === 'Fail') {
                                $('#error').text('The request cannot be completed at the moment, please try again later');
                            }
                            else if (response.status === 'OK') {
                                setTimeout(function () {
                                    $('#error').text('Created successfully');
                                    location.href = response.target;
                                }, 3000);
                            }
                        }
                    });
                });
            }
        </script>
        <script th:if="${addressList != null}">
            $(document).ready(function () {
                $('#address-1').prop('selectedIndex', 0);
            });
        </script>
    </div>

</body>

</html>